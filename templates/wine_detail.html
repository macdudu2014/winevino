<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ wine.name }} - WineVino</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <header>
        <div class="container">
            <a href="/" class="back-link"><i class="fas fa-arrow-left"></i> Back to List</a>
            <h1>Wine Details</h1>
        </div>
    </header>

    <main class="container detail-container">
        <div class="wine-detail-card">
            <div class="detail-header">
                <div class="header-content">
                    <h2>{{ wine.name }}</h2>
                    <div class="badges">
                        <span class="badge type-{{ wine.type|lower }}">{{ wine.type }}</span>
                    </div>
                </div>
                <div class="detail-actions">
                    <a href="{{ wine.url }}" target="_blank" class="external-btn">
                        View on Store <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            </div>

            <div class="detail-grid">
                <div class="detail-image-section">
                    <img src="{{ wine.image_url }}" alt="{{ wine.name }}" class="detail-image"
                        onclick="openImageModal()" style="cursor: zoom-in;" title="Click to zoom">
                </div>
                <div class="detail-main">
                    <div class="price-score-row">
                        <div class="price-box">
                            <span class="label">Price</span>
                            <span class="value price">â‚¬{{ wine.price }}</span>
                        </div>
                        <div class="score-box">
                            <span class="label">Vivino Score</span>
                            <span class="value score">
                                <i class="fas fa-star"></i> {{ wine.vivino_score }}
                            </span>
                        </div>
                        <div class="score-box personal-score-box">
                            <span class="label">My Score</span>
                            <div class="detail-star-rating" id="detail-star-rating">
                                <i class="star far fa-star" data-rating="1"></i>
                                <i class="star far fa-star" data-rating="2"></i>
                                <i class="star far fa-star" data-rating="3"></i>
                                <i class="star far fa-star" data-rating="4"></i>
                                <i class="star far fa-star" data-rating="5"></i>
                            </div>
                            <span class="personal-score-text" id="personal-score-text">Not rated</span>
                        </div>
                    </div>

                    <div class="description-section">
                        <h3>My Notes</h3>
                        <textarea id="wine-description"
                            placeholder="Add your tasting notes or description here...">{{ wine.description }}</textarea>
                    </div>
                </div>

                <div class="detail-pairings">
                    <h3>Food Pairings</h3>
                    <p class="subtitle">Select foods that go well with this wine:</p>

                    <div class="pairing-options">
                        {% set options = ['Red meat', 'White meat', 'Seafood', 'Fish', 'Dessert'] %}
                        {% for option in options %}
                        <label class="checkbox-label">
                            <input type="checkbox" value="{{ option }}" {% if option in wine.pairings %}checked{% endif
                                %}>
                            <span class="checkbox-text">{{ option }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <button id="save-btn" class="save-btn">Save Changes</button>
                    <div id="save-message" class="hidden">Saved!</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Image Zoom Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-image" id="modalImage" src="{{ wine.image_url }}" alt="{{ wine.name }}">
    </div>

    <script>
        const wineName = "{{ wine.name }}";
        const saveBtn = document.getElementById('save-btn');
        const message = document.getElementById('save-message');
        const descriptionInput = document.getElementById('wine-description');
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');

        // Image zoom modal functions
        function openImageModal() {
            document.getElementById('imageModal').style.display = 'flex';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // Load data from localStorage
        function loadLocalData() {
            // Load personal score
            const personalScores = JSON.parse(localStorage.getItem('personalScores') || '{}');
            const score = personalScores[wineName] || 0;
            updateStars(score);

            // Load pairings and description
            const allPairings = JSON.parse(localStorage.getItem('winePairings') || '{}');
            const data = allPairings[wineName];

            if (data) {
                // Update description
                if (data.description) {
                    descriptionInput.value = data.description;
                }

                // Update checkboxes
                if (data.pairings) {
                    checkboxes.forEach(cb => {
                        cb.checked = data.pairings.includes(cb.value);
                    });
                }
            }
        }

        // Personal Score functionality
        const detailStarRating = document.getElementById('detail-star-rating');
        const personalScoreText = document.getElementById('personal-score-text');
        const stars = detailStarRating.querySelectorAll('.star');

        function updateStars(score) {
            stars.forEach((star, idx) => {
                if (idx < score) {
                    star.classList.remove('far');
                    star.classList.add('fas');
                } else {
                    star.classList.remove('fas');
                    star.classList.add('far');
                }
            });

            if (score > 0) {
                personalScoreText.textContent = `${score}/5`;
            } else {
                personalScoreText.textContent = 'Not rated';
            }
        }

        // Initialize on page load
        loadLocalData();

        // Add click handlers to stars
        stars.forEach(star => {
            star.addEventListener('click', (e) => {
                const rating = parseInt(star.dataset.rating);

                // Save to localStorage
                const scores = JSON.parse(localStorage.getItem('personalScores') || '{}');
                scores[wineName] = rating;
                localStorage.setItem('personalScores', JSON.stringify(scores));

                // Update UI
                updateStars(rating);
            });

            // Hover effect
            star.addEventListener('mouseenter', () => {
                const rating = parseInt(star.dataset.rating);
                stars.forEach((s, idx) => {
                    if (idx < rating) {
                        s.style.color = '#FFD700';
                    }
                });
            });
        });

        detailStarRating.addEventListener('mouseleave', () => {
            stars.forEach(s => {
                s.style.color = '';
            });
        });

        saveBtn.addEventListener('click', () => {
            const selectedPairings = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            const description = descriptionInput.value;

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            // Save to localStorage
            try {
                const allPairings = JSON.parse(localStorage.getItem('winePairings') || '{}');
                allPairings[wineName] = {
                    pairings: selectedPairings,
                    description: description
                };
                localStorage.setItem('winePairings', JSON.stringify(allPairings));

                // Success feedback
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Changes';
                message.classList.remove('hidden');
                setTimeout(() => message.classList.add('hidden'), 2000);
            } catch (err) {
                console.error(err);
                saveBtn.disabled = false;
                saveBtn.textContent = 'Error Saving';
            }
        });
    </script>

</body>

</html>